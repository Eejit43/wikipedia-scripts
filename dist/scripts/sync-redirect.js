"use strict";
mw.loader.using(["mediawiki.util"], async () => {
  if (!mw.Title.isTalkNamespace(mw.config.get("wgNamespaceNumber")))
    return;
  const mainPageInfoRevisions = await new mw.Api().get({
    action: "query",
    formatversion: 2,
    prop: "info|revisions",
    rvprop: "content",
    rvslots: "*",
    titles: `${mw.config.get("wgFormattedNamespaces")[mw.config.get("wgNamespaceNumber") - 1]}:${mw.config.get("wgTitle")}`
  });
  if (!mainPageInfoRevisions.query.pages[0].redirect)
    return;
  const link = mw.util.addPortletLink(mw.config.get("skin") === "minerva" ? "p-tb" : "p-cactions", "#", "Sync with main page redirect", "sync-redirect");
  link.addEventListener("click", async (event) => {
    event.preventDefault();
    mw.notify("Editing...", { tag: "sync-redirect-notification" });
    const mainPageContent = mainPageInfoRevisions.query.pages[0].revisions[0].slots.main.content;
    const redirectTarget = /#redirect:? *\[\[(.+)]]/i.exec(mainPageContent)?.[1].replaceAll("_", " ").split("|")[0].split("#")[0].trim();
    if (!redirectTarget)
      return mw.notify("Failed to parse redirect target!", { type: "error", tag: "sync-redirect-notification" });
    const redirectTargetParsed = new DOMParser().parseFromString(redirectTarget, "text/html").documentElement.textContent;
    if (!redirectTargetParsed)
      return mw.notify("Failed to parse redirect target!", { type: "error", tag: "sync-redirect-notification" });
    const mwRedirectTarget = mw.Title.newFromText(redirectTargetParsed);
    if (!mwRedirectTarget)
      return mw.notify("Failed to parse redirect target!", { type: "error", tag: "sync-redirect-notification" });
    const mainTargetText = mwRedirectTarget.getMainText();
    const pageMove = /{{ *r(edirect)?( from)?(( a)? page)? (move|rename|pm) *}}/i.test(mainPageContent);
    const destinationTalkNamespaceName = mw.config.get("wgFormattedNamespaces")[mwRedirectTarget.getNamespaceId() + 1];
    await new mw.Api().edit(mw.config.get("wgPageName"), () => ({
      text: `#REDIRECT [[${destinationTalkNamespaceName}:${mainTargetText}]]${pageMove ? "\n\n{{Redirect category shell|\n{{R from move}}\n}}" : ""}`,
      summary: `Sync redirect with main page, to [[${destinationTalkNamespaceName}:${mainTargetText}]] (via [[User:Eejit43/scripts/sync-redirect|script]])`,
      minor: true
    })).catch(async (errorCode, { error }) => {
      if (errorCode === "nocreate-missing")
        await new mw.Api().create(
          mw.config.get("wgPageName"),
          { summary: `Create redirect matching main page, to [[${destinationTalkNamespaceName}:${mainTargetText}]] (via [[User:Eejit43/scripts/sync-redirect|script]])` },
          `#REDIRECT [[${destinationTalkNamespaceName}:${mainTargetText}]]${pageMove ? "\n\n{{Redirect category shell|\n{{R from move}}\n}}" : ""}`
        ).catch((errorCode2, { error: error2 }) => {
          mw.notify(`Failed to redirect page: ${error2.info} (${errorCode2})`, { type: "error", tag: "sync-redirect-notification" });
        });
      else
        mw.notify(`Failed to redirect page: ${error.info} (${errorCode})`, { type: "error", tag: "sync-redirect-notification" });
    });
    mw.notify("Successfully redirected page, reloading...", { type: "success", tag: "sync-redirect-notification" });
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set("redirect", "no");
    window.location.href = newUrl.href;
  });
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc2NyaXB0cy9zeW5jLXJlZGlyZWN0LnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyJpbXBvcnQgeyBNZWRpYVdpa2lEYXRhRXJyb3IsIFBhZ2VSZXZpc2lvbnNSZXN1bHQgfSBmcm9tICcuLi9nbG9iYWwtdHlwZXMnO1xuXG5tdy5sb2FkZXIudXNpbmcoWydtZWRpYXdpa2kudXRpbCddLCBhc3luYyAoKSA9PiB7XG4gICAgaWYgKCFtdy5UaXRsZS5pc1RhbGtOYW1lc3BhY2UobXcuY29uZmlnLmdldCgnd2dOYW1lc3BhY2VOdW1iZXInKSkpIHJldHVybjtcbiAgICBjb25zdCBtYWluUGFnZUluZm9SZXZpc2lvbnMgPSAoYXdhaXQgbmV3IG13LkFwaSgpLmdldCh7XG4gICAgICAgIGFjdGlvbjogJ3F1ZXJ5JyxcbiAgICAgICAgZm9ybWF0dmVyc2lvbjogMixcbiAgICAgICAgcHJvcDogJ2luZm98cmV2aXNpb25zJyxcbiAgICAgICAgcnZwcm9wOiAnY29udGVudCcsXG4gICAgICAgIHJ2c2xvdHM6ICcqJyxcbiAgICAgICAgdGl0bGVzOiBgJHttdy5jb25maWcuZ2V0KCd3Z0Zvcm1hdHRlZE5hbWVzcGFjZXMnKVttdy5jb25maWcuZ2V0KCd3Z05hbWVzcGFjZU51bWJlcicpIC0gMV19OiR7bXcuY29uZmlnLmdldCgnd2dUaXRsZScpfWAsXG4gICAgfSkpIGFzIFBhZ2VSZXZpc2lvbnNSZXN1bHQgJiB7IHF1ZXJ5OiB7IHBhZ2VzOiB7IHJlZGlyZWN0PzogYm9vbGVhbiB9W10gfSB9O1xuICAgIGlmICghbWFpblBhZ2VJbmZvUmV2aXNpb25zLnF1ZXJ5LnBhZ2VzWzBdLnJlZGlyZWN0KSByZXR1cm47XG5cbiAgICBjb25zdCBsaW5rID0gbXcudXRpbC5hZGRQb3J0bGV0TGluayhtdy5jb25maWcuZ2V0KCdza2luJykgPT09ICdtaW5lcnZhJyA/ICdwLXRiJyA6ICdwLWNhY3Rpb25zJywgJyMnLCAnU3luYyB3aXRoIG1haW4gcGFnZSByZWRpcmVjdCcsICdzeW5jLXJlZGlyZWN0Jyk7XG5cbiAgICBsaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgbXcubm90aWZ5KCdFZGl0aW5nLi4uJywgeyB0YWc6ICdzeW5jLXJlZGlyZWN0LW5vdGlmaWNhdGlvbicgfSk7XG5cbiAgICAgICAgY29uc3QgbWFpblBhZ2VDb250ZW50OiBzdHJpbmcgPSBtYWluUGFnZUluZm9SZXZpc2lvbnMucXVlcnkucGFnZXNbMF0ucmV2aXNpb25zWzBdLnNsb3RzLm1haW4uY29udGVudDtcblxuICAgICAgICBjb25zdCByZWRpcmVjdFRhcmdldCA9IC8jcmVkaXJlY3Q6PyAqXFxbXFxbKC4rKV1dL2kuZXhlYyhtYWluUGFnZUNvbnRlbnQpPy5bMV0ucmVwbGFjZUFsbCgnXycsICcgJykuc3BsaXQoJ3wnKVswXS5zcGxpdCgnIycpWzBdLnRyaW0oKTtcbiAgICAgICAgaWYgKCFyZWRpcmVjdFRhcmdldCkgcmV0dXJuIG13Lm5vdGlmeSgnRmFpbGVkIHRvIHBhcnNlIHJlZGlyZWN0IHRhcmdldCEnLCB7IHR5cGU6ICdlcnJvcicsIHRhZzogJ3N5bmMtcmVkaXJlY3Qtbm90aWZpY2F0aW9uJyB9KTtcblxuICAgICAgICBjb25zdCByZWRpcmVjdFRhcmdldFBhcnNlZCA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcocmVkaXJlY3RUYXJnZXQsICd0ZXh0L2h0bWwnKS5kb2N1bWVudEVsZW1lbnQudGV4dENvbnRlbnQ7XG4gICAgICAgIGlmICghcmVkaXJlY3RUYXJnZXRQYXJzZWQpIHJldHVybiBtdy5ub3RpZnkoJ0ZhaWxlZCB0byBwYXJzZSByZWRpcmVjdCB0YXJnZXQhJywgeyB0eXBlOiAnZXJyb3InLCB0YWc6ICdzeW5jLXJlZGlyZWN0LW5vdGlmaWNhdGlvbicgfSk7XG5cbiAgICAgICAgY29uc3QgbXdSZWRpcmVjdFRhcmdldCA9IG13LlRpdGxlLm5ld0Zyb21UZXh0KHJlZGlyZWN0VGFyZ2V0UGFyc2VkKTtcbiAgICAgICAgaWYgKCFtd1JlZGlyZWN0VGFyZ2V0KSByZXR1cm4gbXcubm90aWZ5KCdGYWlsZWQgdG8gcGFyc2UgcmVkaXJlY3QgdGFyZ2V0IScsIHsgdHlwZTogJ2Vycm9yJywgdGFnOiAnc3luYy1yZWRpcmVjdC1ub3RpZmljYXRpb24nIH0pO1xuXG4gICAgICAgIGNvbnN0IG1haW5UYXJnZXRUZXh0ID0gbXdSZWRpcmVjdFRhcmdldC5nZXRNYWluVGV4dCgpO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VNb3ZlID0gL3t7ICpyKGVkaXJlY3QpPyggZnJvbSk/KCggYSk/IHBhZ2UpPyAobW92ZXxyZW5hbWV8cG0pICp9fS9pLnRlc3QobWFpblBhZ2VDb250ZW50KTtcbiAgICAgICAgY29uc3QgZGVzdGluYXRpb25UYWxrTmFtZXNwYWNlTmFtZSA9IG13LmNvbmZpZy5nZXQoJ3dnRm9ybWF0dGVkTmFtZXNwYWNlcycpW213UmVkaXJlY3RUYXJnZXQuZ2V0TmFtZXNwYWNlSWQoKSArIDFdO1xuICAgICAgICBhd2FpdCBuZXcgbXcuQXBpKClcbiAgICAgICAgICAgIC5lZGl0KG13LmNvbmZpZy5nZXQoJ3dnUGFnZU5hbWUnKSwgKCkgPT4gKHtcbiAgICAgICAgICAgICAgICB0ZXh0OiBgI1JFRElSRUNUIFtbJHtkZXN0aW5hdGlvblRhbGtOYW1lc3BhY2VOYW1lfToke21haW5UYXJnZXRUZXh0fV1dJHtwYWdlTW92ZSA/ICdcXG5cXG57e1JlZGlyZWN0IGNhdGVnb3J5IHNoZWxsfFxcbnt7UiBmcm9tIG1vdmV9fVxcbn19JyA6ICcnfWAsXG4gICAgICAgICAgICAgICAgc3VtbWFyeTogYFN5bmMgcmVkaXJlY3Qgd2l0aCBtYWluIHBhZ2UsIHRvIFtbJHtkZXN0aW5hdGlvblRhbGtOYW1lc3BhY2VOYW1lfToke21haW5UYXJnZXRUZXh0fV1dICh2aWEgW1tVc2VyOkVlaml0NDMvc2NyaXB0cy9zeW5jLXJlZGlyZWN0fHNjcmlwdF1dKWAsXG4gICAgICAgICAgICAgICAgbWlub3I6IHRydWUsXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIC5jYXRjaChhc3luYyAoZXJyb3JDb2RlOiBzdHJpbmcsIHsgZXJyb3IgfTogTWVkaWFXaWtpRGF0YUVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ25vY3JlYXRlLW1pc3NpbmcnKVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXcgbXcuQXBpKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jcmVhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXcuY29uZmlnLmdldCgnd2dQYWdlTmFtZScpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgc3VtbWFyeTogYENyZWF0ZSByZWRpcmVjdCBtYXRjaGluZyBtYWluIHBhZ2UsIHRvIFtbJHtkZXN0aW5hdGlvblRhbGtOYW1lc3BhY2VOYW1lfToke21haW5UYXJnZXRUZXh0fV1dICh2aWEgW1tVc2VyOkVlaml0NDMvc2NyaXB0cy9zeW5jLXJlZGlyZWN0fHNjcmlwdF1dKWAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgI1JFRElSRUNUIFtbJHtkZXN0aW5hdGlvblRhbGtOYW1lc3BhY2VOYW1lfToke21haW5UYXJnZXRUZXh0fV1dJHtwYWdlTW92ZSA/ICdcXG5cXG57e1JlZGlyZWN0IGNhdGVnb3J5IHNoZWxsfFxcbnt7UiBmcm9tIG1vdmV9fVxcbn19JyA6ICcnfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yQ29kZTogc3RyaW5nLCB7IGVycm9yIH06IE1lZGlhV2lraURhdGFFcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG13Lm5vdGlmeShgRmFpbGVkIHRvIHJlZGlyZWN0IHBhZ2U6ICR7ZXJyb3IuaW5mb30gKCR7ZXJyb3JDb2RlfSlgLCB7IHR5cGU6ICdlcnJvcicsIHRhZzogJ3N5bmMtcmVkaXJlY3Qtbm90aWZpY2F0aW9uJyB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGVsc2UgbXcubm90aWZ5KGBGYWlsZWQgdG8gcmVkaXJlY3QgcGFnZTogJHtlcnJvci5pbmZvfSAoJHtlcnJvckNvZGV9KWAsIHsgdHlwZTogJ2Vycm9yJywgdGFnOiAnc3luYy1yZWRpcmVjdC1ub3RpZmljYXRpb24nIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgbXcubm90aWZ5KCdTdWNjZXNzZnVsbHkgcmVkaXJlY3RlZCBwYWdlLCByZWxvYWRpbmcuLi4nLCB7IHR5cGU6ICdzdWNjZXNzJywgdGFnOiAnc3luYy1yZWRpcmVjdC1ub3RpZmljYXRpb24nIH0pO1xuXG4gICAgICAgIGNvbnN0IG5ld1VybCA9IG5ldyBVUkwod2luZG93LmxvY2F0aW9uLmhyZWYpO1xuICAgICAgICBuZXdVcmwuc2VhcmNoUGFyYW1zLnNldCgncmVkaXJlY3QnLCAnbm8nKTtcblxuICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IG5ld1VybC5ocmVmO1xuICAgIH0pO1xufSk7XG4iXSwKICAibWFwcGluZ3MiOiAiO0FBRUEsR0FBRyxPQUFPLE1BQU0sQ0FBQyxnQkFBZ0IsR0FBRyxZQUFZO0FBQzVDLE1BQUksQ0FBQyxHQUFHLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxJQUFJLG1CQUFtQixDQUFDO0FBQUc7QUFDbkUsUUFBTSx3QkFBeUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxFQUFFLElBQUk7QUFBQSxJQUNsRCxRQUFRO0FBQUEsSUFDUixlQUFlO0FBQUEsSUFDZixNQUFNO0FBQUEsSUFDTixRQUFRO0FBQUEsSUFDUixTQUFTO0FBQUEsSUFDVCxRQUFRLEdBQUcsR0FBRyxPQUFPLElBQUksdUJBQXVCLEVBQUUsR0FBRyxPQUFPLElBQUksbUJBQW1CLElBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxPQUFPLElBQUksU0FBUyxD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
