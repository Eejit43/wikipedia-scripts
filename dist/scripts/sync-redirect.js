"use strict";
mw.loader.using(["mediawiki.util"], async () => {
  if (!mw.Title.isTalkNamespace(mw.config.get("wgNamespaceNumber")))
    return;
  const mainPageInfoRevisions = await new mw.Api().get({
    action: "query",
    formatversion: 2,
    prop: "info|revisions",
    rvprop: "content",
    rvslots: "*",
    titles: `${mw.config.get("wgFormattedNamespaces")[mw.config.get("wgNamespaceNumber") - 1]}:${mw.config.get("wgTitle")}`
  });
  if (!mainPageInfoRevisions.query.pages[0].redirect)
    return;
  const link = mw.util.addPortletLink(mw.config.get("skin") === "minerva" ? "p-tb" : "p-cactions", "#", "Sync with main page redirect", "sync-redirect");
  link.addEventListener("click", async (event) => {
    event.preventDefault();
    mw.notify("Editing...", { tag: "sync-redirect-notification" });
    const mainPageContent = mainPageInfoRevisions.query.pages[0].revisions[0].slots.main.content;
    const redirectTarget = /#redirect:? *\[\[(.+)]]/i.exec(mainPageContent)?.[1].replaceAll("_", " ").split("|")[0].split("#")[0].trim();
    if (!redirectTarget)
      return mw.notify("Failed to parse redirect target!", { type: "error", tag: "sync-redirect-notification" });
    const redirectTargetParsed = new DOMParser().parseFromString(redirectTarget, "text/html").documentElement.textContent;
    if (!redirectTargetParsed)
      return mw.notify("Failed to parse redirect target!", { type: "error", tag: "sync-redirect-notification" });
    const mwRedirectTarget = mw.Title.newFromText(redirectTargetParsed);
    if (!mwRedirectTarget)
      return mw.notify("Failed to parse redirect target!", { type: "error", tag: "sync-redirect-notification" });
    const mainTargetText = mwRedirectTarget.getMainText();
    const pageMove = /{{ *r(edirect)?( from)?(( a)? page)? (move|rename|pm) *}}/i.test(mainPageContent);
    const destinationTalkNamespaceName = mw.config.get("wgFormattedNamespaces")[mwRedirectTarget.getNamespaceId() + 1];
    await new mw.Api().edit(mw.config.get("wgPageName"), () => ({
      text: `#REDIRECT [[${destinationTalkNamespaceName}:${mainTargetText}]]${pageMove ? "\n\n{{Redirect category shell|\n{{R from move}}\n}}" : ""}`,
      summary: `Sync redirect with main page, to [[${destinationTalkNamespaceName}:${mainTargetText}]] (via [[User:Eejit43/scripts/sync-redirect|script]])`,
      minor: true
    })).catch(async (errorCode, errorInfo) => {
      if (errorCode === "nocreate-missing")
        await new mw.Api().create(
          mw.config.get("wgPageName"),
          { summary: `Create redirect matching main page, to [[${destinationTalkNamespaceName}:${mainTargetText}]] (via [[User:Eejit43/scripts/sync-redirect|script]])` },
          `#REDIRECT [[${destinationTalkNamespaceName}:${mainTargetText}]]${pageMove ? "\n\n{{Redirect category shell|\n{{R from move}}\n}}" : ""}`
        ).catch((errorCode2, errorInfo2) => {
          mw.notify(`Failed to redirect page: ${errorInfo2?.error.info ?? "Unknown error"} (${errorCode2})`, { type: "error", tag: "sync-redirect-notification" });
        });
      else
        mw.notify(`Failed to redirect page: ${errorInfo?.error.info ?? "Unknown error"} (${errorCode})`, { type: "error", tag: "sync-redirect-notification" });
    });
    mw.notify("Successfully redirected page, reloading...", { type: "success", tag: "sync-redirect-notification" });
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set("redirect", "no");
    window.location.href = newUrl.href;
  });
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc2NyaXB0cy9zeW5jLXJlZGlyZWN0LnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyJpbXBvcnQgeyBNZWRpYVdpa2lEYXRhRXJyb3IsIFBhZ2VSZXZpc2lvbnNSZXN1bHQgfSBmcm9tICcuLi9nbG9iYWwtdHlwZXMnO1xuXG5tdy5sb2FkZXIudXNpbmcoWydtZWRpYXdpa2kudXRpbCddLCBhc3luYyAoKSA9PiB7XG4gICAgaWYgKCFtdy5UaXRsZS5pc1RhbGtOYW1lc3BhY2UobXcuY29uZmlnLmdldCgnd2dOYW1lc3BhY2VOdW1iZXInKSkpIHJldHVybjtcbiAgICBjb25zdCBtYWluUGFnZUluZm9SZXZpc2lvbnMgPSAoYXdhaXQgbmV3IG13LkFwaSgpLmdldCh7XG4gICAgICAgIGFjdGlvbjogJ3F1ZXJ5JyxcbiAgICAgICAgZm9ybWF0dmVyc2lvbjogMixcbiAgICAgICAgcHJvcDogJ2luZm98cmV2aXNpb25zJyxcbiAgICAgICAgcnZwcm9wOiAnY29udGVudCcsXG4gICAgICAgIHJ2c2xvdHM6ICcqJyxcbiAgICAgICAgdGl0bGVzOiBgJHttdy5jb25maWcuZ2V0KCd3Z0Zvcm1hdHRlZE5hbWVzcGFjZXMnKVttdy5jb25maWcuZ2V0KCd3Z05hbWVzcGFjZU51bWJlcicpIC0gMV19OiR7bXcuY29uZmlnLmdldCgnd2dUaXRsZScpfWAsXG4gICAgfSkpIGFzIFBhZ2VSZXZpc2lvbnNSZXN1bHQgJiB7IHF1ZXJ5OiB7IHBhZ2VzOiB7IHJlZGlyZWN0PzogYm9vbGVhbiB9W10gfSB9O1xuICAgIGlmICghbWFpblBhZ2VJbmZvUmV2aXNpb25zLnF1ZXJ5LnBhZ2VzWzBdLnJlZGlyZWN0KSByZXR1cm47XG5cbiAgICBjb25zdCBsaW5rID0gbXcudXRpbC5hZGRQb3J0bGV0TGluayhtdy5jb25maWcuZ2V0KCdza2luJykgPT09ICdtaW5lcnZhJyA/ICdwLXRiJyA6ICdwLWNhY3Rpb25zJywgJyMnLCAnU3luYyB3aXRoIG1haW4gcGFnZSByZWRpcmVjdCcsICdzeW5jLXJlZGlyZWN0JykhO1xuXG4gICAgbGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIG13Lm5vdGlmeSgnRWRpdGluZy4uLicsIHsgdGFnOiAnc3luYy1yZWRpcmVjdC1ub3RpZmljYXRpb24nIH0pO1xuXG4gICAgICAgIGNvbnN0IG1haW5QYWdlQ29udGVudDogc3RyaW5nID0gbWFpblBhZ2VJbmZvUmV2aXNpb25zLnF1ZXJ5LnBhZ2VzWzBdLnJldmlzaW9uc1swXS5zbG90cy5tYWluLmNvbnRlbnQ7XG5cbiAgICAgICAgY29uc3QgcmVkaXJlY3RUYXJnZXQgPSAvI3JlZGlyZWN0Oj8gKlxcW1xcWyguKyldXS9pLmV4ZWMobWFpblBhZ2VDb250ZW50KT8uWzFdLnJlcGxhY2VBbGwoJ18nLCAnICcpLnNwbGl0KCd8JylbMF0uc3BsaXQoJyMnKVswXS50cmltKCk7XG4gICAgICAgIGlmICghcmVkaXJlY3RUYXJnZXQpIHJldHVybiBtdy5ub3RpZnkoJ0ZhaWxlZCB0byBwYXJzZSByZWRpcmVjdCB0YXJnZXQhJywgeyB0eXBlOiAnZXJyb3InLCB0YWc6ICdzeW5jLXJlZGlyZWN0LW5vdGlmaWNhdGlvbicgfSk7XG5cbiAgICAgICAgY29uc3QgcmVkaXJlY3RUYXJnZXRQYXJzZWQgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHJlZGlyZWN0VGFyZ2V0LCAndGV4dC9odG1sJykuZG9jdW1lbnRFbGVtZW50LnRleHRDb250ZW50O1xuICAgICAgICBpZiAoIXJlZGlyZWN0VGFyZ2V0UGFyc2VkKSByZXR1cm4gbXcubm90aWZ5KCdGYWlsZWQgdG8gcGFyc2UgcmVkaXJlY3QgdGFyZ2V0IScsIHsgdHlwZTogJ2Vycm9yJywgdGFnOiAnc3luYy1yZWRpcmVjdC1ub3RpZmljYXRpb24nIH0pO1xuXG4gICAgICAgIGNvbnN0IG13UmVkaXJlY3RUYXJnZXQgPSBtdy5UaXRsZS5uZXdGcm9tVGV4dChyZWRpcmVjdFRhcmdldFBhcnNlZCk7XG4gICAgICAgIGlmICghbXdSZWRpcmVjdFRhcmdldCkgcmV0dXJuIG13Lm5vdGlmeSgnRmFpbGVkIHRvIHBhcnNlIHJlZGlyZWN0IHRhcmdldCEnLCB7IHR5cGU6ICdlcnJvcicsIHRhZzogJ3N5bmMtcmVkaXJlY3Qtbm90aWZpY2F0aW9uJyB9KTtcblxuICAgICAgICBjb25zdCBtYWluVGFyZ2V0VGV4dCA9IG13UmVkaXJlY3RUYXJnZXQuZ2V0TWFpblRleHQoKTtcblxuICAgICAgICBjb25zdCBwYWdlTW92ZSA9IC97eyAqcihlZGlyZWN0KT8oIGZyb20pPygoIGEpPyBwYWdlKT8gKG1vdmV8cmVuYW1lfHBtKSAqfX0vaS50ZXN0KG1haW5QYWdlQ29udGVudCk7XG4gICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uVGFsa05hbWVzcGFjZU5hbWUgPSBtdy5jb25maWcuZ2V0KCd3Z0Zvcm1hdHRlZE5hbWVzcGFjZXMnKVttd1JlZGlyZWN0VGFyZ2V0LmdldE5hbWVzcGFjZUlkKCkgKyAxXTtcbiAgICAgICAgYXdhaXQgbmV3IG13LkFwaSgpXG4gICAgICAgICAgICAuZWRpdChtdy5jb25maWcuZ2V0KCd3Z1BhZ2VOYW1lJyksICgpID0+ICh7XG4gICAgICAgICAgICAgICAgdGV4dDogYCNSRURJUkVDVCBbWyR7ZGVzdGluYXRpb25UYWxrTmFtZXNwYWNlTmFtZX06JHttYWluVGFyZ2V0VGV4dH1dXSR7cGFnZU1vdmUgPyAnXFxuXFxue3tSZWRpcmVjdCBjYXRlZ29yeSBzaGVsbHxcXG57e1IgZnJvbSBtb3ZlfX1cXG59fScgOiAnJ31gLFxuICAgICAgICAgICAgICAgIHN1bW1hcnk6IGBTeW5jIHJlZGlyZWN0IHdpdGggbWFpbiBwYWdlLCB0byBbWyR7ZGVzdGluYXRpb25UYWxrTmFtZXNwYWNlTmFtZX06JHttYWluVGFyZ2V0VGV4dH1dXSAodmlhIFtbVXNlcjpFZWppdDQzL3NjcmlwdHMvc3luYy1yZWRpcmVjdHxzY3JpcHRdXSlgLFxuICAgICAgICAgICAgICAgIG1pbm9yOiB0cnVlLFxuICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAuY2F0Y2goYXN5bmMgKGVycm9yQ29kZTogc3RyaW5nLCBlcnJvckluZm86IE1lZGlhV2lraURhdGFFcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdub2NyZWF0ZS1taXNzaW5nJylcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbmV3IG13LkFwaSgpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY3JlYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG13LmNvbmZpZy5nZXQoJ3dnUGFnZU5hbWUnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHN1bW1hcnk6IGBDcmVhdGUgcmVkaXJlY3QgbWF0Y2hpbmcgbWFpbiBwYWdlLCB0byBbWyR7ZGVzdGluYXRpb25UYWxrTmFtZXNwYWNlTmFtZX06JHttYWluVGFyZ2V0VGV4dH1dXSAodmlhIFtbVXNlcjpFZWppdDQzL3NjcmlwdHMvc3luYy1yZWRpcmVjdHxzY3JpcHRdXSlgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYCNSRURJUkVDVCBbWyR7ZGVzdGluYXRpb25UYWxrTmFtZXNwYWNlTmFtZX06JHttYWluVGFyZ2V0VGV4dH1dXSR7cGFnZU1vdmUgPyAnXFxuXFxue3tSZWRpcmVjdCBjYXRlZ29yeSBzaGVsbHxcXG57e1IgZnJvbSBtb3ZlfX1cXG59fScgOiAnJ31gLFxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvckNvZGU6IHN0cmluZywgZXJyb3JJbmZvOiBNZWRpYVdpa2lEYXRhRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdy5ub3RpZnkoYEZhaWxlZCB0byByZWRpcmVjdCBwYWdlOiAke2Vycm9ySW5mbz8uZXJyb3IuaW5mbyA/PyAnVW5rbm93biBlcnJvcid9ICgke2Vycm9yQ29kZX0pYCwgeyB0eXBlOiAnZXJyb3InLCB0YWc6ICdzeW5jLXJlZGlyZWN0LW5vdGlmaWNhdGlvbicgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBlbHNlIG13Lm5vdGlmeShgRmFpbGVkIHRvIHJlZGlyZWN0IHBhZ2U6ICR7ZXJyb3JJbmZvPy5lcnJvci5pbmZvID8/ICdVbmtub3duIGVycm9yJ30gKCR7ZXJyb3JDb2RlfSlgLCB7IHR5cGU6ICdlcnJvcicsIHRhZzogJ3N5bmMtcmVkaXJlY3Qtbm90aWZpY2F0aW9uJyB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIG13Lm5vdGlmeSgnU3VjY2Vzc2Z1bGx5IHJlZGlyZWN0ZWQgcGFnZSwgcmVsb2FkaW5nLi4uJywgeyB0eXBlOiAnc3VjY2VzcycsIHRhZzogJ3N5bmMtcmVkaXJlY3Qtbm90aWZpY2F0aW9uJyB9KTtcblxuICAgICAgICBjb25zdCBuZXdVcmwgPSBuZXcgVVJMKHdpbmRvdy5sb2NhdGlvbi5ocmVmKTtcbiAgICAgICAgbmV3VXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3JlZGlyZWN0JywgJ25vJyk7XG5cbiAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBuZXdVcmwuaHJlZjtcbiAgICB9KTtcbn0pO1xuIl0sCiAgIm1hcHBpbmdzIjogIjtBQUVBLEdBQUcsT0FBTyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsWUFBWTtBQUM1QyxNQUFJLENBQUMsR0FBRyxNQUFNLGdCQUFnQixHQUFHLE9BQU8sSUFBSSxtQkFBbUIsQ0FBQztBQUFHO0FBQ25FLFFBQU0sd0JBQXlCLE1BQU0sSUFBSSxHQUFHLElBQUksRUFBRSxJQUFJO0FBQUEsSUFDbEQsUUFBUTtBQUFBLElBQ1IsZUFBZTtBQUFBLElBQ2YsTUFBTTtBQUFBLElBQ04sUUFBUTtBQUFBLElBQ1IsU0FBUztBQUFBLElBQ1QsUUFBUSxHQUFHLEdBQUcsT0FBTyxJQUFJLHVCQUF1QixFQUFFLEdB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
